<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bankmen Platinum — Battlepass</title>

  <!-- TAILWIND -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- EMBEDDED BS58 -->
  <script>
    (function () {
      var bas58 = {};

      var _ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      var _BASE = 58;
      var _MAP = {};
      for (var i = 0; i < _ALPHABET.length; i++) {
        _MAP[_ALPHABET.charAt(i)] = i;
      }

      function encode(buffer) {
        if (buffer.length === 0) return '';
        var digits = [0];
        for (var i = 0; i < buffer.length; ++i) {
          for (var j = 0; j < digits.length; ++j) {
            digits[j] <<= 8;
          }
          digits[0] += buffer[i];
          var carry = 0;
          for (var k = 0; k < digits.length; ++k) {
            digits[k] += carry;
            carry = digits[k] / _BASE | 0;
            digits[k] %= _BASE;
          }
          while (carry) {
            digits.push(carry % _BASE);
            carry = carry / _BASE | 0;
          }
        }
        for (var i = 0; buffer[i] === 0 && i < buffer.length - 1; ++i) {
          digits.push(0);
        }
        return digits.reverse().map(function (digit) { return _ALPHABET[digit]; }).join('');
      }

      function decode(string) {
        if (string.length === 0) return new Uint8Array(0);
        var bytes = [0];
        for (var i = 0; i < string.length; i++) {
          var c = string[i];
          if (!(c in _MAP)) throw new Error('Invalid character');
          var value = _MAP[c];
          for (var j = 0; j < bytes.length; ++j) {
            bytes[j] *= _BASE;
          }
          bytes[0] += value;
          var carry = 0;
          for (var j = 0; j < bytes.length; ++j) {
            bytes[j] += carry;
            carry = bytes[j] >> 8;
            bytes[j] &= 0xff;
          }
          while (carry) {
            bytes.push(carry & 0xff);
            carry >>= 8;
          }
        }
        for (var i = 0; string[i] === '1' && i < string.length - 1; ++i) {
          bytes.push(0);
        }
        return new Uint8Array(bytes.reverse());
      }

      bas58.encode = encode;
      bas58.decode = decode;
      window.bs58 = bas58;
    })();
  </script>

  <!-- TWEETNACL -->
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>

  <style>
    body { background: #0a0a14; color: #e5e7eb; font-family: 'Inter', sans-serif; margin: 0; padding: 2rem; }
    .battlepass { background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 16px; padding: 1.5rem; }
    .level { background: #111827; border: 1px solid #374151; border-radius: 12px; padding: 1rem; text-align: center; opacity: 0.4; filter: grayscale(100%); position: relative; }
    .level.unlocked { opacity: 1; filter: none; border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); animation: pulse 2s infinite; }
    .level.coming-soon::after { content: "Coming Soon"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; color: #9ca3af; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); } 50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.6); } }
    .xp-bar { height: 12px; background: #1f2937; border-radius: 6px; overflow: hidden; margin: 1rem 0; }
    .xp-fill { height: 100%; background: linear-gradient(90deg, #fbbf24, #f59e0b); width: 0%; transition: width 1s ease; }
    .hidden { display: none; }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen">

  <div id="connect-section" class="text-center max-w-lg">
    <h1 class="text-5xl font-bold mb-2 text-yellow-400">BANKMEN PLATINUM</h1>
    <p class="text-gray-400 mb-8">Post golf. Earn XP. Unlock glory.</p>
    <button id="connect-btn" class="px-8 py-4 bg-yellow-500 text-black font-bold text-lg rounded-full hover:bg-yellow-400 transition shadow-lg">
      Connect Phantom Wallet
    </button>
    <p id="status" class="mt-6 text-sm text-red-400 min-h-[1.5em]"></p>
  </div>

  <div id="dashboard" class="hidden w-full max-w-5xl mt-10">

    <!-- SEASON BANNER -->
    <div class="mt-10 text-center">
      <h3 class="text-2xl font-bold mb-4 text-yellow-400">Season 1: Sigma Vault Ascent</h3>
      <div class="relative max-w-4xl mx-auto">
        <img src="season1-banner.jpg" alt="Season 1 Wallpaper" class="w-full rounded-xl shadow-2xl border-4 border-yellow-600">
      </div>
    </div>

    <!-- WELCOME MESSAGE AS STATIC TEXT -->
    <div class="mt-12 max-w-4xl mx-auto text-center bg-gradient-to-r from-yellow-900/20 to-yellow-700/20 border-2 border-yellow-600 rounded-xl p-8 shadow-2xl">
      <h2 class="text-4xl font-bold text-yellow-400 mb-4">Welcome to Season 1!</h2>
      <p class="text-xl text-gray-300 mb-4">Season 1 is live. Grind daily for +10 XP, post golf swings, and climb the tiers.</p>
      <p class="text-lg text-gray-400">Exclusive wallpapers, merch, and alpha await. Work hard. Play hard. Flex louder.</p>
    </div>

    <!-- XP BAR + WELCOME HEADER MOVED HERE (ABOVE BATTLEPASS) -->
    <div class="mt-12 max-w-4xl mx-auto bg-gradient-to-b from-gray-900 to-gray-800 rounded-xl p-8 shadow-2xl border border-yellow-600">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-3xl font-bold">Welcome, <span id="wallet">...</span>!</h2>
          <p class="text-gray-400">Your NFT is verified.</p>
        </div>
        <div class="text-right">
          <div class="text-4xl font-bold text-yellow-400" id="xp">0</div>
          <p class="text-sm text-gray-400">Total XP</p>
        </div>
      </div>

      <div class="xp-bar"><div class="xp-fill" id="xp-fill"></div></div>
      <p class="text-sm text-gray-400 text-right mt-2" id="xp-progress">Level <span id="level">1</span> — 0 / 100 XP</p>
    </div>

    <!-- BATTLEPASS LEVELS -->
    <div class="mt-12 battlepass">
      <h3 class="text-2xl font-bold mb-6 text-yellow-400">Battlepass — Season 1: Golf & Glory</h3>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        <div class="level unlocked"><strong>Level 1</strong><br><small>Verified Holder</small></div>
        <div class="level"><strong>Level 2</strong><br><small>Post Golf Video</small></div>
        <div class="level"><strong>Level 3</strong><br><small>RT Bankmen Tweet</small></div>
        <div class="level"><strong>Level 4</strong><br><small>Sticker Pack</small></div>
        <div class="level coming-soon"><strong>Level 5</strong><br><small>Merch Drop</small></div>
        <div class="level coming-soon"><strong>Level 6</strong><br><small>Exclusive NFT</small></div>
        <div class="level coming-soon"><strong>Level 7</strong><br><small>Art Upgrade</small></div>
        <div class="level coming-soon"><strong>Level 8</strong><br><small>Alpha Access</small></div>
      </div>
    </div>

    <a href="https://bankmencapital.com" class="mt-8 px-6 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition">
      Back to Home
    </a>
  </div>

  <script>
    const WORKER_URL = "https://nft-dashboard-verifier.bankmen-verifier.workers.dev";

    let token = null;
    let pubkey = null;
    let currentXP = 0;
    const XP_PER_LEVEL = 100;
    const MAX_LEVEL = 8;

    function waitForPhantom() {
      if (window.solana?.isPhantom && typeof bs58 !== 'undefined') {
        initApp();
      } else {
        setTimeout(waitForPhantom, 100);
      }
    }

    function initApp() {
      const btn = document.getElementById("connect-btn");
      const status = document.getElementById("status");

      btn.onclick = async () => {
        try {
          status.textContent = "Opening Phantom...";
          const resp = await window.solana.connect();
          pubkey = resp.publicKey.toBase58();
          status.textContent = "Signing message...";

          const message = `Bankmen Platinum - ${Date.now()}`;
          const encoded = new TextEncoder().encode(message);
          const result = await window.solana.signMessage(encoded, "utf8");
          const sigBase58 = bs58.encode(result.signature);

          status.textContent = "Verifying NFT...";
          const res = await fetch(`${WORKER_URL}/auth`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pubkey, signature: sigBase58, message })
          });

          const data = await res.json();
          if (data.token) {
            token = data.token;
            document.getElementById("connect-section").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
            document.getElementById("wallet").textContent = pubkey.slice(0,4)+"..."+pubkey.slice(-4);
            await loadXP();
          } else {
            status.textContent = data.error || "No NFT found";
          }
        } catch (err) {
          status.textContent = "Error: " + err.message;
        }
      };
    }

    async function loadXP() {
      const res = await fetch(`${WORKER_URL}/xp?token=${token}`);
      const data = await res.json();
      currentXP = data.xp || 0;
      updateXP();
    }

    function updateXP() {
      const level = Math.min(Math.floor(currentXP / XP_PER_LEVEL) + 1, MAX_LEVEL);
      const progress = (currentXP % XP_PER_LEVEL) / XP_PER_LEVEL * 100;
      document.getElementById("xp").textContent = currentXP;
      document.getElementById("xp-fill").style.width = progress + "%";
      document.getElementById("level").textContent = level;
      document.getElementById("xp-progress").textContent = `Level ${level} — ${currentXP % XP_PER_LEVEL} / ${XP_PER_LEVEL} XP`;

      document.querySelectorAll(".level").forEach((el, i) => {
        el.classList.toggle("unlocked", i + 1 <= level);
        el.classList.toggle("coming-soon", i + 1 > 4);
      });
    }

    waitForPhantom();
  </script>
</body>
</html>
