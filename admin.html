<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bankmen Platinum Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #0f0f23, #1a1a2e); color: #fbbf24; font-family: system-ui, sans-serif; min-height: 100vh; }
    .glass { background: rgba(30,30,60,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(251,191,36,0.3); }
    .tab { @apply px-6 py-3 bg-gray-800 hover:bg-gray-700 cursor-pointer font-bold transition rounded-t-lg; }
    .tab.active { @apply bg-yellow-500 text-black; }
    .btn { @apply px-6 py-3 rounded font-bold transition; }
    .reset { @apply bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded; }
    .danger { @apply bg-red-700 hover:bg-red-600 text-white; }
    table { @apply w-full text-left border-collapse; }
    th { @apply bg-gray-800 p-4 font-bold text-yellow-400 text-sm uppercase tracking-wider; }
    td { @apply p-4 border-t border-gray-700 text-sm; }
    tr:hover { @apply bg-gray-800/50; }
    .tag { @apply inline-block px-2 py-1 text-xs font-bold rounded text-white mr-1; }
  </style>
</head>
<body class="text-white">

<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-5xl font-black text-center mb-2 text-yellow-400 drop-shadow-lg">BANKMEN PLATINUM</h1>
  <p class="text-center text-gray-400 mb-10 text-lg">Admin Dashboard — NOW SHOWS REAL RAFFLE COUNTS</p>

  <!-- TABS -->
  <div class="flex justify-center space-x-1 mb-10 overflow-x-auto bg-gray-900/50 p-1 rounded-lg">
    <div class="tab active" data-tab="users">Users</div>
    <div class="tab" data-tab="missions">Missions</div>
    <div class="tab" data-tab="raffles">Raffles</div>
    <div class="tab" data-tab="tools">Tools</div>
  </div>

  <!-- USERS -->
  <div id="users" class="tab-content">
    <input type="text" id="search" placeholder="Search wallet or @handle..." class="w-full p-4 glass rounded-lg mb-6 text-white placeholder-gray-400 text-lg">
    <div class="glass rounded-xl overflow-hidden shadow-2xl overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>Wallet</th>
            <th>XP</th>
            <th>Level</th>
            <th>Twitter</th>
            <th>Total Tickets</th>
            <th>Real Entries</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="table-body" class="text-gray-300"></tbody>
      </table>
    </div>
  </div>

  <!-- MISSIONS -->
  <div id="missions" class="tab-content hidden">
    <h2 class="text-3xl font-bold mb-6 text-yellow-400">Pending X Submissions</h2>
    <div id="missions-list" class="space-y-5"></div>
  </div>

  <!-- RAFFLES -->
  <div id="raffles" class="tab-content hidden">
    <h2 class="text-3xl font-bold mb-6 text-yellow-400">Raffle Entries</h2>
    <div class="flex flex-wrap gap-4 mb-8">
      <button onclick="loadRaffle('socks')" class="btn bg-indigo-600 hover:bg-indigo-500">Socks</button>
      <button onclick="loadRaffle('pen')" class="btn bg-pink-600 hover:bg-pink-500">Pen</button>
      <button onclick="loadRaffle('polo')" class="btn bg-teal-600 hover:bg-teal-500">Polo</button>
      <button onclick="loadRaffle('mug')" class="btn bg-orange-600 hover:bg-orange-500">Mug</button>
      <button onclick="loadRaffle('watch')" class="btn bg-purple-700 hover:bg-purple-600">Watch</button>
    </div>
    <div id="raffle-list" class="glass p-8 rounded-xl text-center text-gray-400"></div>
  </div>

  <!-- TOOLS -->
  <div id="tools" class="tab-content hidden">
    <h2 class="text-3xl font-bold mb-8 text-yellow-400">Admin Tools</h2>
    <div class="grid md:grid-cols-2 gap-8">
      <div class="glass p-6 rounded-xl">
        <h3 class="text-xl font-bold mb-4">Reset Single User</h3>
        <input id="reset-input" placeholder="Enter wallet address" class="w-full p-4 glass rounded mb-4 text-white">
        <button onclick="resetUser()" class="w-full reset py-3 text-lg">Reset This User</button>
      </div>
      <div class="glass p-6 rounded-xl border border-red-600">
        <h3 class="text-2xl font-bold mb-4 text-red-400">DANGER ZONE</h3>
        <p class="mb-6 text-gray-300">Reset ALL users — new season</p>
        <button onclick="resetAll()" class="w-full danger py-4 text-lg font-bold">RESET ENTIRE SEASON</button>
      </div>
    </div>
  </div>
</div>

<script>
  const ADMIN_KEY = "4924049830";
  const BASE_URL = "https://nft-dashboard-verifier.bankmen-verifier.workers.dev";

  // REAL RAFFLE COUNTS — READS FROM ACTUAL LISTS
  async function getRealRaffleCounts() {
    const items = ["socks", "pen", "polo", "mug", "watch"];
    const counts = {};
    for (const item of items) {
      try {
        const res = await fetch(`${BASE_URL}/raffle-entries?item=${item}`);
        const list = await res.json();
        for (const e of list) {
          counts[e.wallet] = counts[e.wallet] || { socks:0, pen:0, polo:0, mug:0, watch:0, total:0 };
          counts[e.wallet][item]++;
          counts[e.wallet].total++;
        }
      } catch (e) {}
    }
    return counts;
  }

  // Load Users — NOW SHOWS REAL TICKET COUNTS
  async function loadUsers() {
    try {
      const [userRes, raffleCounts] = await Promise.all([
        fetch(`${BASE_URL}/all-users`, { headers: { 'X-Admin-Key': ADMIN_KEY } }).then(r => r.json()),
        getRealRaffleCounts()
      ]);

      if (!Array.isArray(userRes)) throw new Error("Invalid response");

      const search = document.getElementById('search').value.toLowerCase();
      const filtered = userRes.filter(u => 
        u.wallet.toLowerCase().includes(search) || 
        (u.twitter && u.twitter.toLowerCase().includes(search))
      );

      document.getElementById('table-body').innerHTML = filtered.map(u => {
        const real = raffleCounts[u.wallet] || { total: 0, socks:0, pen:0, polo:0, mug:0, watch:0 };
        const items = [];
        if (real.socks) items.push(`<span class="tag bg-indigo-600">socks: ${real.socks}</span>`);
        if (real.pen)   items.push(`<span class="tag bg-pink-600">pen: ${real.pen}</span>`);
        if (real.polo)  items.push(`<span class="tag bg-teal-600">polo: ${real.polo}</span>`);
        if (real.mug)   items.push(`<span class="tag bg-orange-600">mug: ${real.mug}</span>`);
        if (real.watch) items.push(`<span class="tag bg-purple-600">watch: ${real.watch}</span>`);

        return `
          <tr>
            <td class="font-mono text-xs">${u.wallet.slice(0,8)}...${u.wallet.slice(-6)}</td>
            <td class="text-right font-bold text-yellow-400">${u.xp}</td>
            <td class="text-right">${u.level}</td>
            <td>${u.twitter ? '@'+u.twitter : '—'}</td>
            <td class="text-right font-bold text-green-400">${real.total}</td>
            <td>${items.join('') || '—'}</td>
            <td><button onclick="resetUser('${u.wallet}')" class="reset">Reset</button></td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="7" class="text-center py-12 text-gray-500">No users found</td></tr>';

    } catch (e) {
      document.getElementById('table-body').innerHTML = `<tr><td colspan="7" class="text-center py-12 text-red-400">Error: ${e.message}</td></tr>`;
    }
  }

  // Rest of your functions (missions, raffle tab, reset) stay the same
  async function loadMissions() { /* your existing code */ }
  const approve = (w,m) => fetch(`${BASE_URL}/approve-mission`, {method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':ADMIN_KEY},body:JSON.stringify({wallet:w,mission:m,xp:400})}).then(()=>loadMissions());
  const deny   = (w,m) => fetch(`${BASE_URL}/deny-mission`,   {method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':ADMIN_KEY},body:JSON.stringify({wallet:w,mission:m})}).then(()=>loadMissions());

  async function loadRaffle(item) {
    const res = await fetch(`${BASE_URL}/raffle-entries?item=${item}`);
    const entries = await res.json();
    document.getElementById('raffle-list').innerHTML = `
      <h3 class="text-2xl font-bold mb-6 text-yellow-400">${item.toUpperCase()} — ${entries.length} entries</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
        ${entries.map(e => `<div class="bg-gray-800 p-4 rounded font-mono text-center">${e.wallet.slice(0,10)}...</div>`).join('')}
      </div>`;
  }

  function resetUser(w) {
    if (!w) w = document.getElementById('reset-input').value.trim();
    if (!w || !confirm(`Reset ${w.slice(0,10)}...?`)) return;
    fetch(`${BASE_URL}/reset-user`, {method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':ADMIN_KEY},body:JSON.stringify({wallet:w})}).then(()=>loadUsers());
  }

  function resetAll() {
    if (!confirm("RESET EVERY USER?")) return;
    if (prompt("Type: I AM SURE") !== "I AM SURE") return;
    fetch(`${BASE_URL}/reset-all`, {method:'POST',headers:{'X-Admin-Key':ADMIN_KEY}}).then(()=>{alert("Season reset!"); loadUsers();});
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.remove('hidden');
      if (tab.dataset.tab === 'users') loadUsers();
      if (tab.dataset.tab === 'missions') loadMissions();
      if (tab.dataset.tab === 'raffles') loadRaffle('socks');
    };
  });

  loadUsers();
</script>
</body>
</html>
