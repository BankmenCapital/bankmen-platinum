<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bankmen Platinum Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #0f0f23, #1a1a2e); color: #fbbf24; font-family: system-ui, sans-serif; min-height: 100vh; }
    .glass { background: rgba(30,30,60,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(251,191,36,0.3); }
    .tab { @apply px-6 py-3 bg-gray-800 hover:bg-gray-700 cursor-pointer font-bold transition rounded-t-lg; }
    .tab.active { @apply bg-yellow-500 text-black; }
    .reset { @apply bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded; }
    .danger { @apply bg-red-700 hover:bg-red-600 text-white; }
    table { @apply w-full text-left border-collapse; }
    th { @apply bg-gray-800 p-4 font-bold text-yellow-400 text-sm uppercase tracking-wider; }
    td { @apply p-4 border-t border-gray-700 text-sm; }
    tr:hover { @apply bg-gray-800/50; }
    .tag { @apply inline-block px-2 py-1 text-xs font-bold rounded text-white; }
  </style>
</head>
<body class="text-white">

<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-5xl font-black text-center mb-2 text-yellow-400 drop-shadow-lg">BANKMEN PLATINUM</h1>
  <p class="text-center text-gray-400 mb-10 text-lg">Admin Dashboard — Everything Works</p>

  <div class="flex justify-center space-x-1 mb-10 overflow-x-auto bg-gray-900/50 p-1 rounded-lg">
    <div class="tab active" data-tab="users">Users</div>
    <div class="tab" data-tab="missions">Missions</div>
    <div class="tab" data-tab="tools">Tools</div>
  </div>

  <!-- USERS TAB -->
  <div id="users" class="tab-content">
    <input type="text" id="search" placeholder="Search wallet or twitter..." class="w-full p-4 glass rounded-lg mb-6 text-white placeholder-gray-400">
    <div class="glass rounded-xl overflow-hidden shadow-2xl overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>Wallet</th>
            <th>XP</th>
            <th>Level</th>
            <th>Twitter</th>
            <th>Total Tickets</th>
            <th>Items Unlocked</th>
            <th>Reset</th>
          </tr>
        </thead>
        <tbody id="table-body" class="text-gray-300"></tbody>
      </table>
    </div>
  </div>

  <!-- MISSIONS TAB -->
  <div id="missions" class="tab-content hidden">
    <h2 class="text-3xl font-bold mb-6 text-yellow-400">Pending X Submissions</h2>
    <div id="missions-list" class="space-y-5"></div>
  </div>

  <!-- TOOLS -->
  <div id="tools" class="tab-content hidden">
    <h2 class="text-3xl font-bold mb-8 text-yellow-400">Tools</h2>
    <div class="grid md:grid-cols-2 gap-8">
      <div class="glass p-6 rounded-xl">
        <h3 class="text-xl font-bold mb-4">Reset Single User</h3>
        <input id="reset-input" placeholder="Wallet address" class="w-full p-3 glass rounded mb-4">
        <button onclick="resetUser()" class="w-full reset py-3">Reset User</button>
      </div>
      <div class="glass p-6 rounded-xl border border-red-600">
        <h3 class="text-2xl font-bold mb-4 text-red-400">DANGER ZONE</h3>
        <button onclick="resetAll()" class="w-full danger py-4 font-bold">RESET ENTIRE SEASON</button>
      </div>
    </div>
  </div>
</div>

<script>
  const KEY = "4924049830";
  const URL = "https://nft-dashboard-verifier.bankmen-verifier.workers.dev";

  document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x => x.classList.add('hidden'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.remove('hidden');
    if (t.dataset.tab === 'users') load();
    if (t.dataset.tab === 'missions') loadMissions();
  });

  async function load() {
    try {
      const res = await fetch(`${URL}/all-users`, { headers: { 'X-Admin-Key': KEY } });
      if (!res.ok) throw await res.text();
      const users = await res.json();

      const search = document.getElementById('search').value.toLowerCase();
      const filtered = users.filter(u => u.wallet.includes(search) || (u.twitter && u.twitter.toLowerCase().includes(search)));

      document.getElementById('table-body').innerHTML = filtered.map(u => {
        const items = Object.entries(u.raffles || {})
          .map(([item, cnt]) => {
            const colors = { socks: "bg-indigo-600", pen: "bg-pink-600", polo: "bg-teal-600", mug: "bg-orange-600", watch: "bg-purple-600" };
            return `<span class="tag ${colors[item]}">${item}: ${cnt}</span>`;
          }).join(' ');
        return `
          <tr>
            <td class="font-mono text-xs">${u.wallet.slice(0,8)}...${u.wallet.slice(-6)}</td>
            <td class="text-right font-bold text-yellow-400">${u.xp}</td>
            <td class="text-right">${u.level}</td>
            <td>${u.twitter ? '@'+u.twitter : '—'}</td>
            <td class="text-right font-bold text-green-400">${u.raffleCount}</td>
            <td>${items || '—'}</td>
            <td><button onclick="resetUser('${u.wallet}')" class="reset">Reset</button></td>
          </tr>`;
      }).join('') || '<tr><td colspan="7" class="text-center py-12 text-gray-500">No users</td></tr>';
    } catch (e) {
      document.getElementById('table-body').innerHTML = `<tr><td colspan="7" class="text-center py-12 text-red-400">${e}</td></tr>`;
    }
  }

  async function loadMissions() {
    const res = await fetch(`${URL}/missions`);
    const q = await res.json();
    document.getElementById('missions-list').innerHTML = q.length ? q.map(m => `
      <div class="glass p-5 rounded-xl flex justify-between items-center">
        <div>
          <div class="font-bold">${m.wallet.slice(0,10)}...${m.wallet.slice(-8)}</div>
          <div class="text-cyan-400">@${m.twitter}</div>
          <a href="${m.url}" target="_blank" class="text-yellow-400 underline">View Post</a>
        </div>
        <div class="space-x-3">
          <button onclick="fetch('${URL}/approve-mission',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':'${KEY}'},body:JSON.stringify({wallet:'${m.wallet}',mission:'${m.mission}',xp:200})}).then(()=>loadMissions()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 rounded font-bold">+200 XP</button>
          <button onclick="fetch('${URL}/deny-mission',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':'${KEY}'},body:JSON.stringify({wallet:'${m.wallet}',mission:'${m.mission}'})}).then(()=>loadMissions()" class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded font-bold">Deny</button>
        </div>
      </div>
    `).join('') : '<p class="text-center py-16 text-gray-500">No pending missions</p>';
  }

  function resetUser(w) {
    if (!w) w = document.getElementById('reset-input').value.trim();
    if (!w || !confirm('Reset this user?')) return;
    fetch(`${URL}/reset-user`, {method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':KEY},body:JSON.stringify({wallet:w})})
      .then(()=>load());
  }

  function resetAll() {
    if (!confirm('RESET EVERYTHING?')) return;
    if (prompt('Type: I AM SURE') !== 'I AM SURE') return;
    fetch(`${URL}/reset-all`, {method:'POST',headers:{'X-Admin-Key':KEY}})
      .then(()=>{alert('Season reset!'); load();});
  }

  document.getElementById('search').addEventListener('input', load);
  setInterval(() => { if (document.querySelector('.tab.active').dataset.tab==='users') load(); }, 10000);
  load();
</script>
</body>
</html>
